<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planner Estrat√©gico de Estacionalidad 2026 - Argentina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F5F5F0; color: #4A4A4A; }
        .chart-container { 
            position: relative; 
            width: 100%; 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
            height: 300px; 
            max-height: 400px; 
        }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #E5E5E5; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #A3A3A3; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #737373; }

        .btn-transition { transition: all 0.3s ease; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        
        /* Loading Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Markdown Styles */
        .prose h3 { font-weight: 700; margin-top: 1em; margin-bottom: 0.5em; color: #BC6C25; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { color: #4A4A4A; font-weight: 600; }
        
        /* Modal Styles */
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
    </style>
    <!-- Chosen Palette: Warm Neutrals with Gemini Integration -->
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- Header Section -->
    <header class="bg-white border-b border-stone-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-stone-800">üá¶üá∑ Planner Estrat√©gico 2026</h1>
                <p class="text-sm text-stone-500 hidden sm:block">Estacionalidad y Publicidad Digital + <span class="text-[#BC6C25] font-semibold">AI Assistant ‚ú®</span></p>
            </div>
            <div class="text-right flex items-center gap-2">
                <button onclick="openConfigModal()" class="text-stone-400 hover:text-stone-600 transition-colors p-2" title="Configurar API Key">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
                <div class="flex flex-col items-end">
                    <span class="text-xs font-semibold bg-stone-100 text-stone-600 px-2 py-1 rounded border border-stone-200"><a href="mailto:tucorreo@ejemplo.com">@hvelez</a></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full space-y-8">

        <!-- Intro Section -->
        <section class="bg-white rounded-lg p-6 card-shadow border-l-4 border-[#BC6C25]">
            <h2 class="text-lg font-semibold text-stone-800 mb-2">Visi√≥n General</h2>
            <p class="text-stone-600 leading-relaxed">
                Identifica las <strong>Ventanas de Oro</strong> para la inversi√≥n publicitaria en Argentina. 
                Usa el gr√°fico para navegar y selecciona una categor√≠a espec√≠fica para activar el <strong>Asistente AI</strong> y generar estrategias al instante.
            </p>
        </section>

        <!-- Chart Section -->
        <section class="bg-white rounded-lg p-6 card-shadow">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h2 class="text-lg font-semibold text-stone-800">Intensidad de Puja Digital (Estimada)</h2>
                    <p class="text-sm text-stone-500">Haga clic en una barra para cambiar de mes.</p>
                </div>
                <div class="mt-2 md:mt-0">
                    <span class="text-xs text-stone-400">Datos hist√≥ricos CACE + Proyecciones AI</span>
                </div>
            </div>
            
            <div class="w-full bg-stone-50 rounded-lg p-2 border border-stone-100">
                <div class="chart-container">
                    <canvas id="seasonalityChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Dynamic Content Section -->
        <section id="detail-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Context & Selection -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Navigation -->
                <div class="bg-white rounded-lg p-4 card-shadow flex flex-wrap gap-2 justify-center lg:justify-start" id="month-selector">
                    <!-- Buttons injected via JS -->
                </div>

                <!-- Main Context Card -->
                <div class="bg-white rounded-lg p-8 card-shadow min-h-[300px] transition-all duration-300 relative overflow-hidden">
                    <div class="flex items-center gap-3 mb-4">
                        <span id="q-badge" class="px-3 py-1 text-xs font-bold uppercase tracking-wider rounded bg-stone-200 text-stone-600">Q1</span>
                        <h2 id="detail-month" class="text-3xl font-bold text-stone-800">Enero</h2>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-sm font-semibold text-[#BC6C25] uppercase tracking-wide mb-2">Contexto Estrat√©gico</h3>
                        <p id="detail-context" class="text-lg text-stone-600 leading-relaxed">
                            Seleccione un mes para ver el an√°lisis.
                        </p>
                    </div>

                    <div class="bg-[#F5F5F0] rounded p-4 border border-stone-200">
                        <h3 class="text-sm font-semibold text-stone-700 mb-2">Foco del Per√≠odo</h3>
                        <p id="detail-focus" class="text-stone-600 italic">...</p>
                    </div>
                </div>
                
                <!-- AI Strategy Result Container (Moves here on Mobile, but conceptually linked to action) -->
                <div id="ai-result-card" class="bg-white rounded-lg p-6 card-shadow border border-stone-200 hidden">
                    <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-2">
                        <h3 class="text-lg font-bold text-[#BC6C25] flex items-center gap-2">
                            ‚ú® Estrategia Generada
                        </h3>
                        <span class="text-xs text-stone-400">Gemini 2.5 Flash</span>
                    </div>
                    <div id="ai-output-content" class="prose prose-stone text-sm leading-relaxed text-stone-600 max-w-none">
                        <!-- Content goes here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Actionable Data & AI Tool -->
            <div class="space-y-6">
                
                <!-- Categories Card (Now Interactive) -->
                <div class="bg-white rounded-lg p-6 card-shadow flex flex-col">
                    <div class="mb-4 border-b border-stone-100 pb-2">
                        <h3 class="text-lg font-semibold text-stone-800">1. Selecciona Categor√≠a</h3>
                        <p class="text-xs text-stone-500">Elige un nicho para activar la AI</p>
                    </div>
                    <div id="detail-categories" class="flex flex-wrap gap-2">
                        <!-- Categories injected via JS -->
                    </div>
                </div>

                <!-- AI Generator Trigger -->
                <div class="bg-gradient-to-br from-stone-800 to-stone-700 rounded-lg p-6 card-shadow text-white relative overflow-hidden">
                    <div class="relative z-10">
                        <h3 class="text-lg font-bold mb-2 flex items-center gap-2">
                            2. Asistente de Campa√±a ‚ú®
                        </h3>
                        <p class="text-stone-300 text-xs mb-4">
                            Genera ideas de audiencia, keywords y copy para <span id="selected-cat-display" class="font-bold text-white border-b border-white/30">...</span> en <span id="selected-month-display" class="font-bold text-white border-b border-white/30">...</span>.
                        </p>
                        <button id="generate-btn" onclick="generateAIStrategy()" disabled 
                            class="w-full py-2 px-4 bg-[#BC6C25] hover:bg-[#A35D20] disabled:bg-stone-600 disabled:cursor-not-allowed text-white font-semibold rounded shadow-lg transition-all flex justify-center items-center gap-2">
                            <span id="btn-text">Generar Ideas ‚ú®</span>
                            <div id="loading-dots" class="hidden flex gap-1">
                                <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                                <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                                <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                            </div>
                        </button>
                    </div>
                    <!-- Decor -->
                    <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-white/5 rounded-full blur-xl"></div>
                </div>

                <!-- Top Brands/URLs Card -->
                <div class="bg-white rounded-lg p-6 card-shadow flex flex-col max-h-[300px]">
                    <h3 class="text-lg font-semibold text-stone-800 mb-4 border-b border-stone-100 pb-2">Top Referentes</h3>
                    <div id="detail-urls" class="space-y-3 flex-grow custom-scroll overflow-y-auto">
                        <!-- URLs injected via JS -->
                    </div>
                </div>

            </div>
        </section>

        <!-- Strategy Tips Section -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 pt-8 border-t border-stone-300">
            <div class="bg-white p-6 rounded-lg card-shadow border-t-4 border-[#BC6C25]">
                <h3 class="font-bold text-stone-800 mb-2 text-lg">üí° Anticipaci√≥n</h3>
                <p class="text-stone-600 text-sm">Las b√∫squedas gen√©ricas comienzan <strong>3 semanas antes</strong>. Inicia Awareness temprano.</p>
            </div>
            <div class="bg-white p-6 rounded-lg card-shadow border-t-4 border-[#D4A373]">
                <h3 class="font-bold text-stone-800 mb-2 text-lg">üí≥ Financiaci√≥n</h3>
                <p class="text-stone-600 text-sm">"Cuotas Sin Inter√©s" aumenta el <strong>CTR un 30-40%</strong> en tickets medios/altos.</p>
            </div>
            <div class="bg-white p-6 rounded-lg card-shadow border-t-4 border-stone-600">
                <h3 class="font-bold text-stone-800 mb-2 text-lg">üöö Log√≠stica</h3>
                <p class="text-stone-600 text-sm">El "Env√≠o en 24hs" es el driver de compra <strong>n√∫mero #1</strong> en fechas cr√≠ticas.</p>
            </div>
        </section>

    </main>

    <footer class="bg-stone-800 text-stone-400 py-8 mt-12">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-sm">¬© 2026 Planner de Publicidad Digital | Creado por @hvelez </p>
        </div>
    </footer>

    <!-- Config Modal -->
    <div id="config-modal" class="fixed inset-0 z-[100] hidden">
        <div class="modal-overlay absolute inset-0 w-full h-full" onclick="closeConfigModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl p-6 w-[90%] max-w-md">
            <h3 class="text-xl font-bold text-stone-800 mb-4">Configurar Gemini API</h3>
            <p class="text-sm text-stone-600 mb-4">
                Para usar la IA fuera del entorno de prueba, necesitas tu propia API Key. Es gratuita y segura (se guarda solo en tu navegador).
            </p>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Tu API Key</label>
                    <input type="password" id="api-key-input" placeholder="Pega tu clave AIza..." 
                        class="w-full border border-stone-300 rounded p-2 text-sm focus:border-[#BC6C25] focus:ring-1 focus:ring-[#BC6C25] outline-none">
                </div>
                <div class="flex gap-2">
                    <button onclick="saveApiKey()" class="flex-1 bg-[#BC6C25] text-white py-2 rounded font-semibold hover:bg-[#A35D20] transition-colors">Guardar</button>
                    <button onclick="closeConfigModal()" class="flex-1 bg-stone-100 text-stone-600 py-2 rounded font-semibold hover:bg-stone-200 transition-colors">Cancelar</button>
                </div>
                <div class="text-center pt-2">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-[#BC6C25] underline hover:text-[#A35D20]">
                        Conseguir API Key gratis &rarr;
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- API Configuration with LocalStorage ---
        let userApiKey = localStorage.getItem('gemini_api_key') || "";
        
        // System injection check (for demo environment only)
        const systemKey = ""; 

        function getEffectiveKey() {
            // Prioritize user key, then system key (empty in export), then prompt
            if (userApiKey) return userApiKey;
            if (systemKey) return systemKey;
            return null;
        }

        // --- Data Source ---
        const calendarData = [
            {
                id: 0,
                month: "Enero",
                q: "Q1",
                focus: "Cuidado personal, turismo y preparaci√≥n escolar.",
                intensity: 80,
                context: "Pico m√°ximo de calor y vacaciones. La inversi√≥n digital se dispara en productos de protecci√≥n y disfrute al aire libre.",
                categories: ["Protectores solares", "Repelentes de insectos", "Cervezas", "Helados"],
                urls: [
                    { name: "Dermagl√≥s (Solar)", url: "https://www.farmacialeloir.com.ar/marca-dermaglos-solar", note: "L√≠der en Search cuidado piel" },
                    { name: "Cerveza Quilmes", url: "https://www.cotodigital.com.ar/sitios/cdigi/categoria/catalogo-bebidas/_/N-9h2ugZnbmwgdZ1c1jy9y/", note: "Fuerte Display/YouTube" }
                ]
            },
            {
                id: 1,
                month: "Febrero",
                q: "Q1",
                focus: "Cuidado personal, turismo y preparaci√≥n escolar.",
                intensity: 90,
                context: "\"Vuelta al Cole\" (Back to School). Segunda temporada m√°s fuerte para ciertos nichos. La puja en \"mochilas\" o \"√∫tiles\" sube dr√°sticamente.",
                categories: ["Mochilas", "Zapatillas escolares", "Librer√≠a", "Loncheras"],
                urls: [
                    { name: "Footy (Mochilas)", url: "https://www.tiendafooty.com/mochilas-y-bolsos/", note: "Alta tracci√≥n social" },
                    { name: "JanSport", url: "https://www.jansport.com.ar/", note: "Instagram/TikTok Ads" }
                ]
            },
            {
                id: 2,
                month: "Marzo",
                q: "Q1",
                focus: "Cuidado personal, turismo y preparaci√≥n escolar.",
                intensity: 75,
                context: "Mes de la Mujer (8M) y transici√≥n al oto√±o. Cambio de guardarropa y cosm√©tica.",
                categories: ["Skincare", "Maquillaje", "Regalos corporativos", "Ropa media estaci√≥n"],
                urls: [
                    { name: "Natura Cosm√©ticos", url: "https://www.naturacosmeticos.com.ar/", note: "Venta directa digital" },
                    { name: "Farmacity", url: "https://www.farmacity.com/", note: "Google Shopping" }
                ]
            },
            {
                id: 3,
                month: "Abril",
                q: "Q2",
                focus: "Comida reconfortante y eventos de descuento.",
                intensity: 85,
                context: "Semana Santa y Pascuas. Consumo masivo de chocolate, muy corto pero de alta intensidad (2 semanas).",
                categories: ["Huevos de Pascua", "Pescado", "Chocolates premium"],
                urls: [
                    { name: "Arcor (Pascuas)", url: "https://www.arcor.com/ar", note: "Domina inventario ads" },
                    { name: "Puro Cacao", url: "https://purocacao.com/", note: "Nicho ticket alto" }
                ]
            },
            {
                id: 4,
                month: "Mayo",
                q: "Q2",
                focus: "Comida reconfortante y eventos de descuento.",
                intensity: 100,
                context: "üî• HOT SALE. Pico de conversi√≥n del semestre. Todo consumo masivo lanza packs \"X por Y\".",
                categories: ["Tecnolog√≠a", "Electrodom√©sticos", "Indumentaria", "Vuelos"],
                urls: [
                    { name: "Mercado Libre", url: "https://www.mercadolibre.com.ar/", note: "Mayor anunciante" },
                    { name: "Fr√°vega", url: "https://www.fravega.com/", note: "Inversi√≥n Tecnolog√≠a" }
                ]
            },
            {
                id: 5,
                month: "Junio",
                q: "Q2",
                focus: "Comida reconfortante y eventos de descuento.",
                intensity: 80,
                context: "Llegada del fr√≠o intenso y D√≠a del Padre (3er domingo).",
                categories: ["Caf√©s", "Sopas", "Calefacci√≥n", "Herramientas", "Vinos"],
                urls: [
                    { name: "Cabrales", url: "https://tienda.cabrales.com/", note: "Search caf√© grano" },
                    { name: "Knorr (Sopas)", url: "https://www.masonline.com.ar/sopas/knorr", note: "Video YouTube" }
                ]
            },
            {
                id: 6,
                month: "Julio",
                q: "Q3",
                focus: "Hogar, Ni√±os y Limpieza profunda.",
                intensity: 85,
                context: "Vacaciones de invierno. Entretenimiento en casa, apps de delivery y turismo interno.",
                categories: ["Streaming", "Juegos de mesa", "Delivery comida", "Calzado invierno"],
                urls: [
                    { name: "Havanna", url: "https://www.havanna.com.ar/", note: "Estrella turismo" },
                    { name: "PedidosYa", url: "https://www.pedidosya.com.ar/", note: "Inversi√≥n agresiva apps" }
                ]
            },
            {
                id: 7,
                month: "Agosto",
                q: "Q3",
                focus: "Hogar, Ni√±os y Limpieza profunda.",
                intensity: 90,
                context: "D√≠a de las Infancias (3er domingo). Es la \"Navidad\" de las jugueter√≠as.",
                categories: ["Juguetes", "Gaming", "Ropa infantil", "Bicicletas"],
                urls: [
                    { name: "Kinderland", url: "https://jugueteriascarrousel.com.ar/", note: "Retailers fuertes" },
                    { name: "Sony Store", url: "https://store.sony.com.ar/", note: "Gaming/Consolas" }
                ]
            },
            {
                id: 8,
                month: "Septiembre",
                q: "Q3",
                focus: "Hogar, Ni√±os y Limpieza profunda.",
                intensity: 75,
                context: "Primavera. Estacionalidad de alergias y limpieza de hogar (\"Spring Cleaning\").",
                categories: ["Antial√©rgicos (OTC)", "Limpieza", "Jardiner√≠a", "Aires Acond. (Pre)"],
                urls: [
                    { name: "Skip / Unilever", url: "https://www.skip.com.ar/", note: "L√≠der CleanTok" },
                    { name: "Easy Argentina", url: "https://www.easy.com.ar/", note: "Temporada Jard√≠n" }
                ]
            },
            {
                id: 9,
                month: "Octubre",
                q: "Q4",
                focus: "Regalos, Descuentos y Fiestas.",
                intensity: 95,
                context: "D√≠a de la Madre (3er domingo). Ticket promedio m√°s alto en regalos despu√©s de Navidad.",
                categories: ["Perfumes", "Celulares", "Spa/Experiencias", "Peque√±os electro"],
                urls: [
                    { name: "Juleriaque", url: "https://www.juleriaque.com.ar/", note: "Domina KW perfumes" },
                    { name: "Samsung", url: "https://shop.samsung.com/ar/", note: "Lanzamientos Q4" }
                ]
            },
            {
                id: 10,
                month: "Noviembre",
                q: "Q4",
                focus: "Regalos, Descuentos y Fiestas.",
                intensity: 100,
                context: "üíª CYBER MONDAY y Black Friday. Mes de pura performance y venta online.",
                categories: ["Tecnolog√≠a", "Viajes verano", "Aires Acondicionados"],
                urls: [
                    { name: "Despegar", url: "https://www.despegar.com.ar/", note: "Reactiva verano" },
                    { name: "Cetrogar", url: "https://www.cetrogar.com.ar/", note: "Retail Interior" }
                ]
            },
            {
                id: 11,
                month: "Diciembre",
                q: "Q4",
                focus: "Regalos, Descuentos y Fiestas.",
                intensity: 100,
                context: "Navidad, A√±o Nuevo y Cajas Corporativas. Consumo masivo y regalos generales.",
                categories: ["Pan Dulce", "Sidras", "Juguetes", "Regalos generales"],
                urls: [
                    { name: "Diarco", url: "https://www.diarco.com.ar/", note: "Cajas Navide√±as" },
                    { name: "Chocolezza", url: "https://www.chocolezza.com.ar/", note: "Estacionalidad Pyme" }
                ]
            }
        ];

        // --- Global State ---
        let selectedMonthIndex = 0; // Default to Jan
        let selectedCategory = null; // Currently selected category string
        let chartInstance = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            renderMonthSelector();
            updateDashboard(0);
            
            // Populate config input if key exists
            if (userApiKey) {
                document.getElementById('api-key-input').value = userApiKey;
            }
        });

        // --- Config Modal Logic ---
        function openConfigModal() {
            document.getElementById('config-modal').classList.remove('hidden');
        }

        function closeConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input').value.trim();
            if (input) {
                userApiKey = input;
                localStorage.setItem('gemini_api_key', input);
                closeConfigModal();
                alert('¬°API Key guardada correctamente!');
            } else {
                alert('Por favor ingresa una clave v√°lida.');
            }
        }

        // --- Visualization: Chart.js ---
        function initChart() {
            const ctx = document.getElementById('seasonalityChart').getContext('2d');
            
            // Warm Neutral Palette Mapping
            const colorNormal = '#D4A373'; // Sand
            const colorHigh = '#BC6C25';   // Terra cotta
            const colorMax = '#9C4221';    // Darker rust for peaks

            const backgroundColors = calendarData.map(d => {
                if (d.intensity >= 95) return colorMax;
                if (d.intensity >= 85) return colorHigh;
                return colorNormal;
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: calendarData.map(d => d.month.substring(0, 3)),
                    datasets: [{
                        label: 'Intensidad de Puja (Estimada)',
                        data: calendarData.map(d => d.intensity),
                        backgroundColor: backgroundColors,
                        borderRadius: 4,
                        hoverBackgroundColor: '#4A4A4A',
                        barPercentage: 0.7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            updateDashboard(index);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#FFFFFF',
                            titleColor: '#333333',
                            bodyColor: '#666666',
                            borderColor: '#E5E5E5',
                            borderWidth: 1,
                            callbacks: {
                                label: (context) => `Intensidad: ${context.raw}/100`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: '#E5E5E5', borderDash: [5, 5] },
                            ticks: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: 'Inter' } }
                        }
                    }
                }
            });
        }

        // --- Functional Logic ---

        function renderMonthSelector() {
            const container = document.getElementById('month-selector');
            calendarData.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.textContent = item.month.substring(0, 3);
                btn.className = `px-3 py-1 text-sm rounded border transition-colors duration-200 
                    ${index === selectedMonthIndex 
                        ? 'bg-stone-800 text-white border-stone-800' 
                        : 'bg-white text-stone-600 border-stone-200 hover:bg-stone-100'}`;
                btn.onclick = () => updateDashboard(index);
                btn.id = `month-btn-${index}`;
                container.appendChild(btn);
            });
        }

        function updateDashboard(index) {
            selectedMonthIndex = index;
            const data = calendarData[index];
            selectedCategory = null; // Reset selection on month change
            updateAIButtonState();
            hideAIResults(); // Hide previous results

            // Update Labels
            document.getElementById('selected-month-display').textContent = data.month;
            document.getElementById('selected-cat-display').textContent = "...";

            // 1. Update Buttons State
            calendarData.forEach((_, i) => {
                const btn = document.getElementById(`month-btn-${i}`);
                if (btn) {
                    if (i === index) {
                        btn.className = 'px-3 py-1 text-sm rounded border transition-colors duration-200 bg-stone-800 text-white border-stone-800 shadow-sm';
                    } else {
                        btn.className = 'px-3 py-1 text-sm rounded border transition-colors duration-200 bg-white text-stone-600 border-stone-200 hover:bg-stone-100';
                    }
                }
            });

            // 2. Update Context Card
            const monthEl = document.getElementById('detail-month');
            const qEl = document.getElementById('q-badge');
            const contextEl = document.getElementById('detail-context');
            const focusEl = document.getElementById('detail-focus');

            // Fade effect
            contextEl.style.opacity = '0';
            setTimeout(() => {
                monthEl.textContent = data.month;
                qEl.textContent = data.q;
                contextEl.textContent = data.context;
                focusEl.textContent = data.focus;
                
                if (data.intensity >= 95) monthEl.className = "text-3xl font-bold text-[#9C4221]";
                else if (data.intensity >= 85) monthEl.className = "text-3xl font-bold text-[#BC6C25]";
                else monthEl.className = "text-3xl font-bold text-stone-800";

                contextEl.style.opacity = '1';
            }, 150);

            // 3. Update Categories (Interactive Buttons)
            const catContainer = document.getElementById('detail-categories');
            catContainer.innerHTML = '';
            data.categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = "inline-block px-3 py-1 bg-stone-100 text-stone-700 text-sm rounded-full border border-stone-200 hover:border-[#BC6C25] hover:text-[#BC6C25] transition-colors focus:outline-none focus:ring-2 focus:ring-[#BC6C25]/50";
                btn.textContent = cat;
                btn.onclick = () => selectCategory(cat, btn);
                catContainer.appendChild(btn);
            });

            // 4. Update URLs
            const urlContainer = document.getElementById('detail-urls');
            urlContainer.innerHTML = '';
            data.urls.forEach(brand => {
                const wrapper = document.createElement('div');
                wrapper.className = "p-3 border border-stone-200 rounded hover:bg-stone-50 transition-colors flex justify-between items-center group";
                
                wrapper.innerHTML = `
                    <div>
                        <div class="font-bold text-stone-800 text-sm">${brand.name}</div>
                        <div class="text-xs text-stone-500 italic">${brand.note}</div>
                    </div>
                    <a href="${brand.url}" target="_blank" rel="noopener noreferrer" 
                       class="opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity bg-[#BC6C25] hover:bg-[#A35D20] text-white text-xs px-3 py-1.5 rounded">
                       Ver &#8599;
                    </a>
                `;
                urlContainer.appendChild(wrapper);
            });
        }

        function selectCategory(cat, btnElement) {
            selectedCategory = cat;
            document.getElementById('selected-cat-display').textContent = cat;
            updateAIButtonState();
            
            // Visual feedback
            const allBtns = document.getElementById('detail-categories').children;
            for(let b of allBtns) {
                b.className = "inline-block px-3 py-1 bg-stone-100 text-stone-700 text-sm rounded-full border border-stone-200 hover:border-[#BC6C25] hover:text-[#BC6C25] transition-colors";
            }
            btnElement.className = "inline-block px-3 py-1 bg-[#BC6C25] text-white text-sm rounded-full border border-[#BC6C25] shadow-md transform scale-105 transition-all";
            
            // Hide previous results if changing category
            hideAIResults();
        }

        function updateAIButtonState() {
            const btn = document.getElementById('generate-btn');
            if (selectedCategory) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function hideAIResults() {
             document.getElementById('ai-result-card').classList.add('hidden');
             document.getElementById('ai-output-content').innerHTML = '';
        }

        // --- GEMINI API INTEGRATION ---
        
        async function generateAIStrategy() {
            if (!selectedCategory) return;
            
            // Get Key (from storage or system)
            const currentKey = getEffectiveKey();
            if (!currentKey) {
                openConfigModal();
                alert("Por favor configura tu API Key primero para usar esta funci√≥n.");
                return;
            }

            const monthName = calendarData[selectedMonthIndex].month;
            const monthContext = calendarData[selectedMonthIndex].context;
            
            const btn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const loaders = document.getElementById('loading-dots');
            const resultCard = document.getElementById('ai-result-card');
            const outputContent = document.getElementById('ai-output-content');

            // UI Loading State
            btn.disabled = true;
            btnText.textContent = "Generando Estrategia...";
            loaders.classList.remove('hidden');
            loaders.classList.add('flex');
            
            // Construct Prompt
            const prompt = `Act√∫a como un estratega experto en marketing digital para el mercado argentino.
            
            Genera una estrategia t√°ctica r√°pida para:
            - Producto/Categor√≠a: "${selectedCategory}"
            - Mes: "${monthName}"
            - Contexto Estacional: "${monthContext}"
            
            Tu respuesta debe estar en formato Markdown y contener exactamente estos 3 puntos (se breve y directo):
            
            1. **üéØ Perfil de Audiencia (Target):** Define demograf√≠a e intereses clave en Argentina para este mes.
            2. **üîë 3 Palabras Clave (Keywords):** Para Google Ads (High Intent).
            3. **üí° Idea de Anuncio (Instagram/TikTok):** Un titular gancho y una breve descripci√≥n visual para un Reel o Story.
            
            Usa emojis. S√© conciso.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error('API Error');

                const data = await response.json();
                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar la estrategia. Intente nuevamente.";

                // Render Markdown
                outputContent.innerHTML = marked.parse(rawText);
                resultCard.classList.remove('hidden');
                
                // Scroll to result on mobile
                if(window.innerWidth < 1024) {
                    resultCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

            } catch (error) {
                console.error(error);
                outputContent.innerHTML = `<p class="text-red-500">Error al conectar con Gemini. Verifique su API Key o conexi√≥n.</p>`;
                resultCard.classList.remove('hidden');
            } finally {
                // Reset UI
                btn.disabled = false;
                btnText.textContent = "Generar Nuevas Ideas ‚ú®";
                loaders.classList.add('hidden');
                loaders.classList.remove('flex');
            }
        }

    </script>
</body>
</html>
